#+TITLE: ARLJohnston Emacs Configuration
#+Author: Alistair Johnston
#+Description: My Emacs configuration
#+PROPERTY: header-args :tangle ~/.emacs.d/init.el
#+auto_tangle: t
#+STARTUP: showeverything
#+OPTIONS: toc:2

* My Emacs Configuration

** Unorganised
#+BEGIN_SRC emacs-lisp
(setq ring-bell-function 'ignore)
(setq-default flycheck-emacs-lisp-load-path 'inherit)

(unless (package-installed-p 'editorconfig)
	(package-install 'editorconfig))

(use-package copilot
	:straight (:host github :repo "zerolfx/copilot.el" :files ("dist" "*.el"))
	:defer t
	;; :init
	;; (define-key copilot-completion-map (kbd "<tab>") 'copilot-accept-completion)
)

;; Read at high WPM
(use-package spray)

(use-package flycheck)

(use-package imenu-list
	:init
	(setq imenu-list-focus-after-activation t)
)

;;Better autocomplete
(use-package vertico
	:custom
	(vertico-count 13)
	(vertico-resize t)
	(vertico-cycle nil)
	:config
	(vertico-mode)
	:init
	(setq read-file-name-completion-ignore-case t
		read-buffer-completion-ignore-case t
		completion-ignore-case t)
)

(desktop-save-mode 1)
(setq desktop-load-locked-desktop t)
;; Persist history over Emacs restarts. Vertico sorts by history position.
(use-package savehist
	:init
	(savehist-mode))

;; Emacs 28 and newer: Hide commands in M-x which do not work in the current mode.  Vertico commands are hidden in normal buffers. This setting is useful beyond Vertico.
(setq read-extended-command-predicate #'command-completion-default-include-p)


(setq backup-directory-alist '((".*" . "~/.backups/")))

(use-package yaml-mode)
#+END_SRC


** LSP
#+BEGIN_SRC emacs-lisp
(use-package lsp-mode
	:init
	(keymap-global-set "M-RET" 'lsp-execute-code-action)
;;Modes
	(add-hook 'nix-mode-hook #'lsp)
)

(use-package lsp-ui
	:init
	(setq lsp-ui-doc-position 'bottom)
	(add-hook 'lsp-mode-hook 'lsp-ui-mode)
)

#+END_SRC

** Org Mode
Org mode allows for literate programming (like this document) and writing notes etc in a nice, structured way with multiple export options.
#+BEGIN_SRC emacs-lisp
(use-package org
	:init
	(setq org-src-preserve-indentation t)
)

(use-package org-auto-tangle
	:init
	(add-hook 'org-mode-hook 'org-auto-tangle-mode)
	(setq org-auto-tangle-default t)
)

(use-package org-sticky-header-mode
	:straight (:type git :host github :repo "alphapapa/org-sticky-header")
	:defer t
	:init
	(setq org-sticky-header-full-path 'full)
	(setq org-sticky-header-outline-path-seperator " / ")
	(add-hook 'org-mode-hook 'org-sticky-header-mode)
)

(use-package org-superstar
	:init
	(add-hook 'org-mode-hook 'org-superstar-mode)
	(setq org-hide-leading-stars t)
	(setq org-superstar-leading-bullet ?\s)
	(setq org-indent-mode-turns-on-hiding-stars nil)
)

(use-package htmlize)

(org-babel-do-load-languages
 'org-babel-load-languages
 '((emacs-lisp . t)
	(haskell . t)))

(use-package org-roam
	:init
	(setq org-roam-directory "~/org")

	(setq org-roam-capture-templates
		'(("d" "default" plain
			"%?"
			:if-new (file+head "${slug}-%<%Y%m%d%H%M%S>.org"
				"#+title: ${title}\n")
			:unnarrowed t
			:jump-to-captured t)
		("m" "meeting" plain
			"%?"
			:if-new (file+head "${slug}-%<%Y%m%d%H%M%S>.org"
				"=================\n** Meeting %U\nAttendees:\n")
			:unnarrowed t
			:jump-to-captured t)))

	(setq org-todo-keywords
		'((sequence "TODO" "IN-PROGRESS" "DONE")))
	(setq org-clock-in-switch-to-state "IN-PROGRESS")
)

(defun org-agenda-sort-at-point ()
		(interactive)
	(org-sort-entries nil ?o)
	(org-sort-entries nil ?o))

(defun org-agenda-sort-headers ()
	"Sort each header in the current buffer."
	(interactive)
	(org-map-entries (lambda () (org-sort-entries nil ?o)) nil 'tree))

(add-hook 'before-save-hook #'org-agenda-sort-headers)
#+END_SRC

** Theming
#+BEGIN_SRC emacs-lisp
;; (use-package solarized-theme
;;		:init
;;		(load-theme 'solarized-gruvbox-dark t)
;;		(add-hook 'after-make-frame-functions
;;			(lambda (frame)
;;				(select-frame frame)
;;				(load-theme 'solarized-gruvbox-dark t)))
;; )

(add-to-list 'custom-theme-load-path "~/.emacs.d/everforest-emacs")
(load-file "~/.emacs.d/everforest-emacs/everforest-hard-dark-theme.el")
(load-theme 'everforest-hard-dark t)

;; (use-package everforest
	;; :straight (everforest :type git
											;; :host nil
											;; :repo "https://git.sr.ht/~theorytoe/everforest-theme")
	;; :init
	;; (load-theme 'everforest-hard-dark t)
;; )

(use-package doom-modeline
	:ensure t
	:init
		(doom-modeline-mode 1)
		(display-battery-mode)
	:custom
		(doom-modeline-icon nil)
		(doom-modeline-height 1)
		(doom-modeline-bar-width 1)
		(doom-modeline-buffer-file-name-style 'truncate-upto-project)
		(doom-modeline-minor-modes nil)
		;;(doom-modeline-enable-word-count nil)
		(doom-modeline-buffer-encoding t)
		(doom-modeline-indent-info nil)
		(doom-modeline-checker-simple-format t)
		(doom-modeline-vcs-max-length 12)
		(doom-modeline-env-version t)
		(doom-modeline-irc-stylize 'identity)
		(doom-modeline-github-timer nil)
		(doom-modeline-gnus-timer nil)
)

;; Less Jumpy scrolling
(setq scroll-step 1)
(setq scroll-margin 4)

(set-face-attribute 'default nil :font "MonoLisa Nerd Font")
(tool-bar-mode -1)
(menu-bar-mode -1)
(scroll-bar-mode -1)
(global-display-line-numbers-mode 1)
(setq display-line-numbers-type 'relative)
(setq default-tab-width 2)
(setq-default tab-width 2)
(electric-indent-mode -1)

(global-whitespace-mode)
;; Default marks, but make tabs appear as two spaces
(setq whitespace-display-mappings
	'((space-mark 32
							 [183]
							 [46])
	 (space-mark 160
							 [164]
							 [95])
	 (newline-mark 10
								 [36 10])
	 (tab-mark 9
						 [183 183]
						 [95 95]))
)
(setq whitespace-style (delq 'lines whitespace-style))
(setq whitespace-style (delq 'tabs whitespace-style))


(add-hook 'before-save-hook #'whitespace-cleanup)

(winner-mode 1)
(keymap-global-set "C-c h" 'winner-undo)
(keymap-global-set "C-c l" 'winner-redo)

(keymap-global-set "C-c c" 'comment-or-uncomment-region)
(keymap-global-set "C-c /" 'comment-or-uncomment-region)

;;(keymap-global-set "g r" 'revert-buffer)

(global-visual-line-mode)

;; (require 'table)
(setq warning-minimum-level :error)
#+END_SRC

** Evil Mode Configuration
#+BEGIN_SRC emacs-lisp
(use-package evil
	:init
	;;Evil-collection requirement
	(setq evil-want-integration t)
	(setq evil-want-keybinding nil)
	:config
	(evil-mode 1)
	:hook
	(after-init . evil-mode))


(use-package evil-collection
	:init
	(evil-collection-init)
)

(use-package evil-leader
	:init
	(global-evil-leader-mode 1)
	(evil-leader/set-leader "<SPC>")
	(evil-leader/set-key
		"bi" 'fzf-switch-buffer
		"bk" 'kill-this-buffer
		"bm" 'buffer-menu
		"ci" 'org-clock-in
		"co" 'org-clock-out
		"cu" 'org-clock-update-time-maybe
		"cs" 'org-agenda-sort-at-point
		"si" 'imenu-list-smart-toggle
		"m" 'magit
		;;EMMS
		"es" 'toggle-emms
		"el" 'emms-next
		"eh" 'emms-previous
		"ej" 'emms-volume-lower
		"ek" 'emms-volume-raise
		"ni" 'org-roam-node-insert)
		(evil-define-key 'normal dired-mode-map (kbd "h") 'dired-up-directory)
		(evil-define-key 'normal dired-mode-map (kbd "l") 'dired-find-file)
		(evil-define-key 'normal 'global "gr" 'revert-buffer)
)

(use-package undo-tree
	:init
	(global-undo-tree-mode 1)
	(evil-set-undo-system 'undo-tree)
	(setq undo-tree-history-directory-alist '(("." . "~/.backups/")))
	(setq undo-tree-visualizer-timestamps t)
)

;;(evil-leader/set-key "w" '(lambda () (interactive) execute-kbd-macro (read-kbd-macro "C-w")))


#+END_SRC

** Dired
#+BEGIN_SRC emacs-lisp
(use-package dired-preview
	:init
	(dired-preview-global-mode 1)
)
#+END_SRC

** Movement
#+BEGIN_SRC emacs-lisp
(use-package fzf)

(use-package zoxide
	:init
	(evil-leader/set-key "." 'zoxide-travel-with-query)
)

(use-package avy
	:init
	(keymap-global-set "C-;" 'avy-goto-char)
)
#+END_SRC

** Git integration
#+BEGIN_SRC emacs-lisp
(use-package magit)

(use-package blamer
	:straight (:host github :repo "artawower/blamer.el")
	:init
	(blamer-mode 1)
	:bind
		(("s-i" . blamer-show-commit-info))
	:custom
		(blamer-idle-time 0.3)
		(blamer-min-offset 70)
	:custom-face
		(blamer-face ((t :foreground "#81a1c1"
	:defer t
	:background
		nil
	:height
		100
	:italic
		t)))
	:defer t
)
#+END_SRC

** Completion
#+BEGIN_SRC emacs-lisp
(use-package company
	:init
		(setq company-idle-delay 0)
		(setq company-minimum-prefix-length 1)
		(global-company-mode t)
		(setq company-dabbrev-downcase nil)
)
#+END_SRC

** PDF-Tools
#+BEGIN_SRC emacs-lisp
(use-package pdf-tools
	:init
	(pdf-loader-install)
	(add-hook 'pdf-view-mode-hook '(lambda () (display-line-numbers-mode -1)))
	(add-hook 'pdf-view-mode-hook 'pdf-view-midnight-minor-mode)
	:defer t
)


(use-package image-roll
	:straight (:type git :host github :repo "dalanicolai/image-roll.el")
	:defer t
	:init
	(add-hook 'pdf-mode-hook #'(lambda () (interactive) (display-line-numbers-mode -1)))
)

#+END_SRC

** EMMS
#+BEGIN_SRC emacs-lisp
(use-package emms
	:ensure t
	:config
	(setq emms-source-file-default-directory "~/Music/")
	:init
	(emms-all)
	(setq emms-player-list '(emms-player-vlc)
		emms-info-functions '(emms-info-native))
)
#+END_SRC

** Rust
#+BEGIN_SRC emacs-lisp
(use-package rustic
	:init
	(add-hook 'rust-mode-hook #'lsp)
	:defer t
)
(use-package rustfmt
	:defer t
)
#+END_SRC



** Docker
#+BEGIN_SRC emacs-lisp
(use-package docker)
(use-package dockerfile-mode)
#+END_SRC

** Go
#+BEGIN_SRC emacs-lisp
(use-package go-mode
	:init
	(setq compile-command "go test -v")
	(add-hook 'before-save-hook 'gofmt-before-save)
	(add-hook 'go-mode-hook #'lsp)
)

(use-package go-playground
	:init
	(defun my/go-playground-remove-lsp-workspace () (when-let ((root (lsp-workspace-root))) (lsp-workspace-folders-remove root)))
	(add-hook 'go-playground-pre-rm-hook #'my/go-playground-remove-lsp-workspace)
	:defer t
)

(use-package gorepl-mode
	:init
	(add-hook 'go-mode-hook #'gorepl-mode)
	:defer t
)

(use-package yasnippet
	:init
	(setq yas-snippet-dirs
		'("~/Documents/yasnippet-golang")
	)
	(yas-global-mode 1)

	(keymap-global-set "M-s" 'yas-insert-snippet)
)

(yas-minor-mode-on)
#+END_SRC

** Haskell
#+BEGIN_SRC emacs-lisp
(use-package lsp-haskell
	:init
	(add-hook 'haskell-mode-hook #'lsp)
	(add-hook 'haskell-literate-mode-hook #'lsp)
	:defer t
)

;; haskell mode
(use-package haskell-mode
	:init
	(add-hook 'haskell-mode-hook 'interactive-haskell-mode)
	:defer t
)

(use-package flycheck-haskell
	:defer t
)
#+END_SRC
